version: "3.8"

services:
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=${SA_PASSWORD:-YOUR_STRONG_PASSWORD_HERE}
      - MSSQL_PID=Developer
    volumes:
      - sqlserver-data-swarm:/var/opt/mssql
    networks:
      - edm-network-swarm
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: "2.0"
          memory: 2G
        reservations:
          cpus: "1.0"
          memory: 1G
    healthcheck:
      test:
        ["CMD-SHELL", "timeout 1 bash -c '</dev/tcp/localhost/1433' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  backend:
    image: edm-backend:latest
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: production
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:80
      - ConnectionStrings__DefaultConnection=${ConnectionStrings__DefaultConnection:-Server=sqlserver,1433;Database=CatalogDB;User Id=sa;Password=${SA_PASSWORD:-YOUR_STRONG_PASSWORD_HERE};TrustServerCertificate=True;}
      - ConnectionStrings__DockerConnection=${ConnectionStrings__DockerConnection:-Server=sqlserver,1433;Database=CatalogDB;User Id=sa;Password=${SA_PASSWORD:-YOUR_STRONG_PASSWORD_HERE};TrustServerCertificate=True;}
      - JwtSettings__SecretKey=${JwtSettings__SecretKey}
      - JwtSettings__Issuer=${JwtSettings__Issuer:-EdmSystem}
      - JwtSettings__Audience=${JwtSettings__Audience:-EdmClient}
      - JwtSettings__ExpirationMinutes=${JwtSettings__ExpirationMinutes:-60}
      - JwtSettings__RefreshTokenExpirationDays=${JwtSettings__RefreshTokenExpirationDays:-7}
      - Smtp__Provider=${Smtp__Provider:-smtp}
      - FileStorage__BasePath=${FileStorage__BasePath:-FileStorage}
      - FileStorage__MaxFileSizeMB=${FileStorage__MaxFileSizeMB:-100}
      - FileStorage__AllowedExtensions=${FileStorage__AllowedExtensions:-[".pdf",".doc",".docx",".xls",".xlsx",".txt",".jpg",".png",".zip"]}
      - Firebase__StorageBucket=${Firebase__StorageBucket}
      - Firebase__CredentialsPath=${Firebase__CredentialsPath}
      - Firebase__CredentialsJson=${Firebase__CredentialsJson}
      - Frontend__Url=${Frontend__Url:-http://localhost:4200}
    networks:
      - edm-network-swarm
    deploy:
      replicas: 2
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: start-first
      rollback_config:
        parallelism: 1
        delay: 5s
      resources:
        limits:
          cpus: "1.0"
          memory: 1G
        reservations:
          cpus: "0.5"
          memory: 512M
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.backend.rule=PathPrefix(`/api`)"
        - "traefik.http.services.backend.loadbalancer.server.port=80"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:80/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  frontend:
    image: edm-frontend:latest
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: production
    networks:
      - edm-network-swarm
    deploy:
      replicas: 2
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: start-first
      rollback_config:
        parallelism: 1
        delay: 5s
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 256M
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.frontend.rule=PathPrefix(`/`)"
        - "traefik.http.services.frontend.loadbalancer.server.port=80"

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    configs:
      - source: nginx_config
        target: /etc/nginx/conf.d/default.conf
    networks:
      - edm-network-swarm
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
        reservations:
          cpus: "0.25"
          memory: 128M

volumes:
  sqlserver-data-swarm:
    driver: local

networks:
  edm-network-swarm:
    driver: overlay
    attachable: true

configs:
  nginx_config:
    file: ./doc/infrastructure/nginx-swarm.conf
